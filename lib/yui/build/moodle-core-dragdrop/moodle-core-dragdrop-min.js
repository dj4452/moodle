YUI.add("moodle-core-dragdrop",function(d,c){var b={pix:"i/move_2d",largepix:"i/dragdrop",component:"moodle",cssclass:"moodle-core-dragdrop-draghandle"};var a=function(){a.superclass.constructor.apply(this,arguments)};d.extend(a,d.Base,{goingup:null,absgoingup:null,samenodeclass:null,parentnodeclass:null,samenodelabel:null,parentnodelabel:null,groups:[],lastdroptarget:null,listeners:null,initializer:function(){this.listeners=[];this.listeners.push(d.DD.DDM.on("drag:start",this.global_drag_start,this));this.listeners.push(d.DD.DDM.on("drag:end",this.global_drag_end,this));this.listeners.push(d.DD.DDM.on("drag:drag",this.global_drag_drag,this));this.listeners.push(d.DD.DDM.on("drop:over",this.global_drop_over,this));this.listeners.push(d.DD.DDM.on("drop:hit",this.global_drop_hit,this));this.listeners.push(d.DD.DDM.on("drag:dropmiss",this.global_drag_dropmiss,this));this.listeners.push(d.one(d.config.doc.body).delegate("key",this.global_keydown,"down:32, enter, esc","."+b.cssclass,this));this.listeners.push(d.one(d.config.doc.body).delegate("click",this.global_keydown,"."+b.cssclass,this))},destructor:function(){new d.EventHandle(this.listeners).detach()},get_drag_handle:function(k,i,g,f){var e=b.pix;if(f){e=b.largepix}var j=d.Node.create("<img />").setStyle("cursor","move").setAttrs({src:M.util.image_url(e,b.component),alt:k});if(g){j.addClass(g)}var h=d.Node.create("<span></span>").addClass(i).setAttribute("title",k).setAttribute("tabIndex",0).setAttribute("data-draggroups",this.groups).setAttribute("role","button");h.appendChild(j);h.addClass(b.cssclass);return h},lock_drag_handle:function(e,f){e.removeHandle("."+f)},unlock_drag_handle:function(e,f){e.addHandle("."+f);e.get("activeHandle").focus()},ajax_failure:function(f){var g={name:f.status+" "+f.statusText,message:f.responseText};return new M.core.exception(g)},in_group:function(f){var e=false;d.each(this.groups,function(g){if(f._groups[g]){e=true}},this);return e},global_drag_start:function(g){var f=g.target;if(!this.in_group(f)){return}this.originalstyle=f.get("node").getAttribute("style");f.get("node").setStyle("opacity",".25");f.get("dragNode").setStyles({opacity:".75",borderColor:f.get("node").getStyle("borderColor"),backgroundColor:f.get("node").getStyle("backgroundColor")});f.get("dragNode").empty();this.drag_start(g)},global_drag_end:function(g){var f=g.target;if(!this.in_group(f)){return}f.get("node").setAttribute("style",this.originalstyle);this.drag_end(g)},global_drag_drag:function(h){var f=h.target,g=h.info;if(!this.in_group(f)){return}if(g.start[1]<g.xy[1]){this.absgoingup=true}else{if(g.start[1]>g.xy[1]){this.absgoingup=false}}if(g.delta[1]<0){this.goingup=true}else{if(g.delta[1]>0){this.goingup=false}}this.drag_drag(h)},global_drop_over:function(i){if(!i.drop||!i.drop.inGroup(this.groups)){return}var h=i.drag.get("node"),f=i.drop.get("node");this.lastdroptarget=i.drop;if(f.hasClass(this.samenodeclass)){var g;if(this.goingup){g="before"}else{g="after"}f.insert(h,g)}else{if((f.hasClass(this.parentnodeclass)||f.test('[data-droptarget="1"]'))&&!f.contains(h)){if(this.goingup){f.append(h)}else{f.prepend(h)}}}this.drop_over(i)},global_drag_dropmiss:function(f){f.drag=f.target;f.drop=this.lastdroptarget;if(!this.in_group(f.drag)){return}if(!f.drop||!f.drop.inGroup(this.groups)){return}this.drag_dropmiss(f)},global_drop_hit:function(f){if(!f.drop||!f.drop.inGroup(this.groups)){return}this.drop_hit(f)},find_element_text:function(g){var e=g.all("h2, h3, h4, h5, span:not(.actions):not(.menu-action-text), p, div.no-overflow, div.dimmed_text");var f="";e.each(function(){if(f===""){if(d.Lang.trim(this.get("text"))!==""){f=this.get("text")}}});if(f!==""){return f}return M.util.get_string("emptydragdropregion","moodle")},global_start_keyboard_drag:function(l,j,i){M.core.dragdrop.keydragcontainer=i;M.core.dragdrop.keydraghandle=j;var n=this.find_element_text(i);var h=M.util.get_string("movecontent","moodle",n);var o=d.Node.create("<ul></ul>");o.addClass("dragdrop-keyboard-drag");var m,k,g;var f=d.all("."+this.samenodeclass+", ."+this.parentnodeclass);f.each(function(t){var r=false;var e=t;var u=t.getAttribute("class").split(" ").join(", .");if(t.drop&&t.drop.inGroup(this.groups)&&t.drop.get("node")!==i&&t.next(u)!==i){r=true}else{var s=t.getAttribute("data-draggroups").split(" ");var q,p;for(q=0;q<s.length;q++){for(p=0;p<this.groups.length;p++){if(s[q]===this.groups[p]){if(t==i||t.next(u)===i||t.get("children").item(0)==i){r=false}else{r=true;e=t.get("parentNode")}break}}if(r){break}}}if(r){m=d.Node.create("<li></li>");k=d.Node.create("<a></a>");n=this.find_element_text(e);if(this.samenodelabel&&t.hasClass(this.samenodeclass)){g=M.util.get_string(this.samenodelabel.identifier,this.samenodelabel.component,n)}else{if(this.parentnodelabel&&t.hasClass(this.parentnodeclass)){g=M.util.get_string(this.parentnodelabel.identifier,this.parentnodelabel.component,n)}else{g=M.util.get_string("tocontent","moodle",n)}}k.setContent(g);k.setAttribute("data-drop-target",t.get("id"));k.setAttribute("tabindex","0");k.on("click",this.global_keyboard_drop,this);k.on("key",this.global_keyboard_drop,"down:enter,32",this);m.append(k);o.append(m)}},this);M.core.dragdrop.dropui=new M.core.dialogue({headerContent:h,bodyContent:o,draggable:true,visible:true,center:true,modal:true});M.core.dragdrop.dropui.after("visibleChange",function(p){if(p.prevVal&&!p.newVal){this.global_cancel_keyboard_drag()}},this);if(o.one("a")){o.one("a").focus()}},simulated_drag_drop_event:function(g,e){var f=function(h){this.node=h};f.prototype.get=function(h){if(h==="node"||h==="dragNode"||h==="dropNode"){return this.node}if(h==="activeHandle"){return this.node.one(".editing_move")}return null};f.prototype.inGroup=function(){return true};f.prototype.addHandle=function(){};f.prototype.removeHandle=function(){};this.drop=new f(e);this.drag=new f(g);this.target=this.drop},global_keyboard_drop:function(i){var g=M.core.dragdrop.keydragcontainer;var f=d.one("#"+i.target.getAttribute("data-drop-target"));M.core.dragdrop.dropui.hide();i.preventDefault();var h=new this.simulated_drag_drop_event(g,g);var j=new this.simulated_drag_drop_event(g,f);this.drag_start(h);this.global_drop_over(j);if(f.hasClass(this.parentnodeclass)&&f.contains(g)){f.prepend(g)}this.global_drop_hit(j)},global_cancel_keyboard_drag:function(){if(M.core.dragdrop.keydragcontainer){M.core.dragdrop.keydraghandle.focus();M.core.dragdrop.keydragcontainer=null}if(M.core.dragdrop.dropui){M.core.dragdrop.dropui.destroy()}},global_keydown:function(n){var g=n.target.ancestor("."+b.cssclass,true),f,l;if(g===null){return}if(n.keyCode===27){this.global_cancel_keyboard_drag();n.preventDefault();return}if(!g.hasClass(b.cssclass)){return}if(n.keyCode!==13&&n.keyCode!==32&&n.type!=="click"){return}l=g.getAttribute("data-draggroups").split(" ");var k,h;var m=false;for(k=0;k<l.length;k++){for(h=0;h<this.groups.length;h++){if(l[k]===this.groups[h]){m=true;break}}if(m){break}}if(!m){return}f=g.ancestor(".yui3-dd-drop");this.global_start_keyboard_drag(n,g,f);n.preventDefault()},drag_start:function(){},drag_end:function(){},drag_drag:function(){},drag_dropmiss:function(){},drop_over:function(){},drop_hit:function(){}},{NAME:"dragdrop",ATTRS:{}});M.core=M.core||{};M.core.dragdrop=a},"@VERSION@",{requires:["base","node","io","dom","dd","event-key","event-focus","moodle-core-notification"]});